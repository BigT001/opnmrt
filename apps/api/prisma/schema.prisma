generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id              String            @id @default(cuid())
  email           String            @unique
  password        String
  name            String?
  role            UserRole          @default(BUYER)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  tenantId        String?
  storeId         String?
  phone           String?           @unique
  image           String?
  billingAddress  Json?
  savedCards      Json?
  shippingAddress Json?
  cart            Json?
  messages        Message[]
  orders          Order[]
  reviews         Review[]
  passwordHistory PasswordHistory[]
  managedStore    Store?            @relation("StoreOwner")
}

model PasswordHistory {
  id        String   @id @default(cuid())
  userId    String
  password  String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Store {
  id                    String      @id @default(cuid())
  tenantId              String      @unique
  name                  String
  subdomain             String      @unique
  customDomain          String?     @unique
  ownerId               String      @unique
  plan                  String      @default("FREE")
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  accentColor           String?
  biography             String?
  heroImage             String?
  heroSubtitle          String?
  heroTitle             String?
  logo                  String?
  officialEmail         String?
  primaryColor          String?     @default("#10b981")
  theme                 String      @default("DEFAULT")
  themeConfig           Json?
  useWhatsAppCheckout   Boolean     @default(false)
  whatsappNumber        String?
  paystackPublicKey     String?
  paystackSecretKey     String?
  paystackWebhookSecret String?
  analytics             Analytics[]
  inventory             Inventory[]
  messages              Message[]
  orders                Order[]
  payments              Payment[]
  products              Product[]
  owner                 User        @relation("StoreOwner", fields: [ownerId], references: [id])
}

model Product {
  id            String      @id @default(cuid())
  tenantId      String
  storeId       String
  name          String
  description   String?
  price         Decimal     @db.Decimal(10, 2)
  stock         Int         @default(0)
  images        String[]
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  colors        String[]
  sizes         String[]
  discountPrice Decimal?    @db.Decimal(10, 2)
  category      String?
  inventory     Inventory?
  orderItems    OrderItem[]
  reviews       Review[]
  store         Store       @relation(fields: [storeId], references: [id])

  @@index([tenantId])
  @@index([storeId])
}

model Inventory {
  id            String   @id @default(cuid())
  tenantId      String
  storeId       String
  productId     String   @unique
  quantity      Int      @default(0)
  lowStockAlert Int      @default(5)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  product       Product  @relation(fields: [productId], references: [id])
  store         Store    @relation(fields: [storeId], references: [id])

  @@index([tenantId])
  @@index([storeId])
}

model Order {
  id             String      @id @default(cuid())
  tenantId       String
  storeId        String
  buyerId        String
  totalAmount    Decimal     @db.Decimal(10, 2)
  status         String      @default("PENDING")
  paymentRef     String?
  retryCount     Int         @default(0)        // Track payment retry attempts
  lastAttemptAt  DateTime    @default(now()) @updatedAt  // Last payment attempt
  abandonReason  String?     // Why payment wasn't completed
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  messages       Message[]
  buyer          User        @relation(fields: [buyerId], references: [id])
  store          Store       @relation(fields: [storeId], references: [id])
  items          OrderItem[]
  payment        Payment?

  @@index([tenantId])
  @@index([storeId])
  @@index([buyerId])
  @@index([status])  // Add index for faster status queries
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Decimal @db.Decimal(10, 2)
  order     Order   @relation(fields: [orderId], references: [id])
  product   Product @relation(fields: [productId], references: [id])
}

model Payment {
  id        String   @id @default(cuid())
  tenantId  String
  storeId   String
  orderId   String   @unique
  reference String   @unique
  amount    Decimal  @db.Decimal(10, 2)
  status    String
  metadata  Json?
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id])
  store     Store    @relation(fields: [storeId], references: [id])

  @@index([tenantId])
  @@index([storeId])
}

model Analytics {
  id          String   @id @default(cuid())
  tenantId    String
  storeId     String
  date        DateTime
  metricName  String
  metricValue Float
  createdAt   DateTime @default(now())
  store       Store    @relation(fields: [storeId], references: [id])

  @@index([tenantId, date])
  @@index([storeId, date])
}

model Message {
  id          String   @id @default(cuid())
  tenantId    String
  storeId     String
  orderId     String?
  senderId    String
  senderRole  UserRole
  content     String
  createdAt   DateTime @default(now())
  recipientId String?
  isRead      Boolean  @default(false)
  order       Order?   @relation(fields: [orderId], references: [id])
  sender      User     @relation(fields: [senderId], references: [id])
  store       Store    @relation(fields: [storeId], references: [id])

  @@index([tenantId])
  @@index([storeId])
  @@index([orderId])
  @@index([recipientId])
  @@index([senderId])
  @@index([isRead])
}

model EventLog {
  id        String   @id @default(cuid())
  tenantId  String
  storeId   String
  eventType String
  payload   Json
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([storeId])
  @@index([createdAt])
}

enum UserRole {
  ADMIN
  SELLER
  BUYER
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  productId String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([userId])
}
