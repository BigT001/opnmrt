// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  ADMIN
  SELLER
  BUYER
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  phone         String?   @unique
  password      String
  name          String?
  role          UserRole  @default(BUYER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // A buyer is associated with a specific store (tenant-scoped accounts)
  // A seller owns a store
  tenantId      String?   // Only for BUYERs, null for ADMIN/SELLER (SELLER has store)
  storeId       String?   // Only for BUYERs

  managedStore  Store?    @relation("StoreOwner")
  orders        Order[]
  messages      Message[]
}

model Store {
  id            String    @id @default(cuid())
  tenantId      String    @unique // Logical tenant ID
  name          String
  subdomain     String    @unique
  customDomain  String?   @unique
  ownerId       String    @unique
  owner         User      @relation("StoreOwner", fields: [ownerId], references: [id])
  
  plan          String    @default("FREE") // FREE, PAID
  
  // Customization
  logo          String?
  heroImage     String?
  heroTitle     String?
  heroSubtitle  String?
  primaryColor  String?   @default("#10b981") // emerald-500
  accentColor   String?
  
  // Theme System
  theme         String    @default("DEFAULT") // DEFAULT, MINIMAL_LUXE, etc.
  themeConfig   Json?     // Stores overrides like { colors: {...}, fonts: {...} }
  
  biography     String?   @db.Text
  officialEmail String?
  whatsappNumber String?
  useWhatsAppCheckout Boolean @default(false)
  
  products      Product[]
  orders        Order[]
  inventory     Inventory[]
  payments      Payment[]
  analytics     Analytics[]
  messages      Message[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Product {
  id            String    @id @default(cuid())
  tenantId      String
  storeId       String
  store         Store     @relation(fields: [storeId], references: [id])
  
  name          String
  description   String?   @db.Text
  price         Decimal   @db.Decimal(10, 2)
  discountPrice Decimal?  @db.Decimal(10, 2)
  stock         Int       @default(0)
  images        String[]  // Cloudinary URLs
  category      String?
  colors        String[]
  sizes         String[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  inventory     Inventory?
  orderItems    OrderItem[]

  @@index([tenantId])
  @@index([storeId])
}

model Inventory {
  id            String    @id @default(cuid())
  tenantId      String
  storeId       String
  store         Store     @relation(fields: [storeId], references: [id])
  
  productId     String    @unique
  product       Product   @relation(fields: [productId], references: [id])
  
  quantity      Int       @default(0)
  lowStockAlert Int       @default(5)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([tenantId])
  @@index([storeId])
}

model Order {
  id            String    @id @default(cuid())
  tenantId      String
  storeId       String
  store         Store     @relation(fields: [storeId], references: [id])
  
  buyerId       String
  buyer         User      @relation(fields: [buyerId], references: [id])
  
  totalAmount   Decimal   @db.Decimal(10, 2)
  status        String    @default("PENDING") // PENDING, PAID, COMPLETED, CANCELLED
  
  paymentRef    String?   // Paystack reference
  
  items         OrderItem[]
  payment       Payment?
  messages      Message[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([tenantId])
  @@index([storeId])
  @@index([buyerId])
}

model OrderItem {
  id            String    @id @default(cuid())
  orderId       String
  order         Order     @relation(fields: [orderId], references: [id])
  
  productId     String
  product       Product   @relation(fields: [productId], references: [id])
  
  quantity      Int
  price         Decimal   @db.Decimal(10, 2)
}

model Payment {
  id            String    @id @default(cuid())
  tenantId      String
  storeId       String
  store         Store     @relation(fields: [storeId], references: [id])
  
  orderId       String    @unique
  order         Order     @relation(fields: [orderId], references: [id])
  
  reference     String    @unique
  amount        Decimal   @db.Decimal(10, 2)
  status        String
  metadata      Json?
  
  createdAt     DateTime  @default(now())

  @@index([tenantId])
  @@index([storeId])
}

model Analytics {
  id            String    @id @default(cuid())
  tenantId      String
  storeId       String
  store         Store     @relation(fields: [storeId], references: [id])
  
  date          DateTime
  metricName    String
  metricValue   Float
  
  createdAt     DateTime  @default(now())

  @@index([tenantId, date])
  @@index([storeId, date])
}

model Message {
  id            String    @id @default(cuid())
  tenantId      String
  storeId       String
  store         Store     @relation(fields: [storeId], references: [id])
  
  orderId       String?
  order         Order?    @relation(fields: [orderId], references: [id])
  
  senderId      String
  sender        User      @relation(fields: [senderId], references: [id])
  senderRole    UserRole
  
  content       String    @db.Text
  
  recipientId   String?   // For direct messages (e.g., SELLER to specific BUYER)
  isRead        Boolean   @default(false)
  
  createdAt     DateTime  @default(now())

  @@index([tenantId])
  @@index([storeId])
  @@index([orderId])
  @@index([recipientId])
  @@index([senderId])
  @@index([isRead])
}

model EventLog {
  id            String    @id @default(cuid())
  tenantId      String
  storeId       String
  eventType     String    // ORDER_CREATED, STOCK_UPDATED, etc.
  payload       Json
  createdAt     DateTime  @default(now())

  @@index([tenantId])
  @@index([storeId])
  @@index([createdAt])
}
